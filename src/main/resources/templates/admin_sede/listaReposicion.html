<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <meta name="description" content="POS - Bootstrap Admin Template">
    <meta name="keywords" content="admin, estimates, bootstrap, business, corporate, creative, management, minimal, modern,  html5, responsive">
    <meta name="author" content="Dreamguys - Bootstrap Admin Template">
    <meta name="robots" content="noindex, nofollow">
    <title>SaintMedic</title>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets_superAdmin/img/PastillaSinFondo.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/assets_superAdmin/css/bootstrap.min.css">

    <!-- animation CSS -->
    <link rel="stylesheet" href="/assets_superAdmin/css/animate.css">

    <!-- Datatable CSS -->
    <link rel="stylesheet" href="/assets_superAdmin/css/dataTables.bootstrap4.min.css">

    <!-- Fontawesome CSS -->
    <link rel="stylesheet" href="/assets_superAdmin/plugins/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="/assets_superAdmin/plugins/fontawesome/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Main CSS -->
    <link rel="stylesheet" href="/assets_superAdmin/css/style.css">
</head>
<body>
<div id="global-loader" >
    <div class="whirly-loader"> </div>
</div>
<!-- Main Wrapper -->
<div class="main-wrapper">
    <style>

        </style>
    <!-- Header -->
    <div th:replace="headerAdminSede"> </div>

    <!-- Header -->

    <!-- Sidebar -->
    <div th:replace="sidebarAdmin :: sidebarAdmin(activeTab = 'listaReposicion')"> </div>
    <!-- /Sidebar -->

    <!-- Button trigger modal -->
    <div class="page-wrapper">
        <div class="content">
            <div class="card mb-0">
                <div class="card-body">
                    <h4 class="card-title">Lista de reposiciones</h4>
                    <div class="table-responsive dataview">
                        <table class="table datatable ">
                            <thead>
                            <tr>
                                <th>Identificador</th>
                                <th>Detalles</th>
                                <th>Fecha de solicitud</th>
                                <th>Estado del pedido</th>
                                <th>Editar</th>
                            </tr>
                            </thead>
                            <tbody >
                            <tr th:each="repo, vEstado: ${listaReposicion}">
                                <td th:text="${repo.idReplacementOrder}"></td>
                                <td class="productimgname" style="text-align: center;">
                                    <a  th:id="|${repo.idReplacementOrder}|"  type="button" class="product-img" >
                                        <img  src="/assets_superAdmin/images/gaseovet.jpg" alt="product">
                                    </a>
                                </td>
                                <!--
                                <td><span class="badges bg-lightgreen" th:if="${repo.getTrackingState()} == 'Entregado' " th:text="${repo.getTrackingState()}" ></span></td>
                                <td><span class="badges bg-lightgreen" th:if="${repo.getTrackingState()} == 'En ruta' " th:text="${repo.getTrackingState()}" ></span></td>
                                <td><span class="badges bg-lightgreen" th:if="${repo.getTrackingState()} == 'Empaquetado' " th:text="${repo.getTrackingState()}" ></span></td>
                                <td><span class="badges bg-lightgreen" th:if="${repo.getTrackingState()} == 'En Proceso' " th:text="${repo.getTrackingState()}" ></span></td>
                                <td><span class="badges bg-lightgreen" th:if="${repo.getTrackingState()} == 'Solicitado' " th:text="${repo.getTrackingState()}" ></span></td>
                                -->
                                <td th:text="${repo.getReleaseDate()}"></td>
                                <td><span class="badges bg-lightgreen" th:text="${repo.getTrackingState()}" ></span></td>

                                <td th:if="${repo.getTrackingState() == 'Solicitado'  || repo.getTrackingState() == 'En Proceso'}">
                                    <a class="me-3" href="#">
                                        <img src="/assets_superAdmin/img/icons/edit.svg" th:id="|idPedidoEditar${repo.getIdReplacementOrder()}|" alt="img">
                                    </a>
                                    <a class="me-3 confirm-text" th:id="|idPedido${repo.getIdReplacementOrder()}|">
                                        <img src="/assets_superAdmin/img/icons/delete.svg" alt="img">
                                    </a>
                                </td>
                                <td th:if="${!(repo.getTrackingState() == 'Solicitado'  || repo.getTrackingState() == 'En Proceso')}">
                                    -
                                </td>
                                <script th:inline="javascript" >
                                    $("#idPedidoEditar" + [[${repo.idReplacementOrder}]]).click( function() { data={
                                        idPedidoReposicion : [[${repo.idReplacementOrder}]]
                                    }
                                        $.ajax({
                                            url: "/verDetalleRepoMedicamentos",
                                            type: "POST",
                                            data: data,
                                            success:  function (response) {
                                                console.log(response);
                                                var Header = '<form id="A'+[[${repo.idReplacementOrder}]] +'" >'+ "<table class=\"table\">\n                                                                  <thead>\n                                                                    <tr>\n                                                                      <th>#</th>\n                                                                      <th>Nombre</th>\n                                                                                                                                           <th>Precio</th>\n                                                                      <th>Cantidad</th>\n                                                                    </tr>\n                                                                  </thead>\n                                                                  <tbody>";
                                                var rowx;
                                                var count = 1;
                                                var rows = "";
                                                response.forEach(function (producto) {
                                                    var aux = JSON.parse(producto)
                                                    rowx =
                                                        '<tr> ' +
                                                        '<td>' + count + '</td>'
                                                        +
                                                        '<td>' + aux.name + '</td>'
                                                        +

                                                        '<td>' + 's/.' + aux.price + '</td>'

                                                        +
                                                        '<td>' + "<input " + "id='" + aux.id + "'" + " type='number' value='" + aux.initial + "'>" + '</td>'
                                                        +
                                                        '</tr>'
                                                    ;
                                                    rows = rows + rowx + '</form>';
                                                    count++;
                                                })
                                                var final = "</tbody>\n                                                                </table>";
                                                console.log("HOLAAA1");
                                                const getInputs = () => {
                                                    return new Promise ((resolve, rejected)=>{
                                                        Swal.fire({
                                                            title: 'Medicamentos de la orden de reposición',
                                                            html: Header + rows + final,
                                                            confirmButtonColor: "#dd986a",
                                                            confirmButtonText: "Editar",
                                                            cancelButtonText: "Regresar",
                                                            preConfirm: () => {
                                                                const inputs = [];
                                                                const form = document.querySelector('#A'+[[${repo.idReplacementOrder}]]);
                                                                form.querySelectorAll('input').forEach(input => {
                                                                    inputs.push(input.value);
                                                                });
                                                                resolve(inputs);
                                                            }
                                                        })
                                                    })
                                                }
                                                async function esperarPopUp (){
                                                    try {
                                                        const datosFetched = await getInputs();
                                                        console.log("Hola");
                                                        console.log(datosFetched);
                                                        const jsonString = JSON.stringify(datosFetched);
                                                        //Validaciones :D
                                                        var oli = [];
                                                        for(let i =0 ;  i<datosFetched.length ; i++ ){
                                                            try {
                                                                const numero = parseInt(datosFetched[i]); // Intenta parsear "texto" a un número
                                                                if(numero<=0){
                                                                    oli.push("ErrorTipoDeNumero");
                                                                }
                                                            } catch (error) {
                                                                oli.push("ErrorCasteo");
                                                            }
                                                        }
                                                        var countErrorTipoNumero = 0 ;
                                                        var countErrorCasteo = 0 ;
                                                        for(let j = 0 ; j<oli.length ;j++ ){
                                                            if(oli[j] === "ErrorTipoDeNumero" ){
                                                                countErrorTipoNumero++;
                                                            }
                                                            if(oli[j] === "ErrorCasteo" ){
                                                                countErrorCasteo++;
                                                            }
                                                        }
                                                        if(countErrorCasteo>0 ||countErrorTipoNumero >0 ){
                                                            Swal.fire({
                                                                icon: "error",
                                                                title: "Oops...",
                                                                text: "Ingresaste una cantidad incoherente!",
                                                            });
                                                        }else{
                                                            datosFetched.push([[${repo.idReplacementOrder}]]);
                                                            console.log(""+datosFetched);
                                                            $.ajax({
                                                                url:"/editarPedidoReposicionAdminSede",
                                                                data: JSON.stringify({ datos: datosFetched }),
                                                                type: "POST",
                                                                contentType: "application/json",
                                                                success:  window.location.href = "/verListaReposicion"
                                                            })
                                                            }
                                                    } catch (error) {
                                                        console.error(error);
                                                    }
                                                }
                                                esperarPopUp();
                                            },
                                        })
                                    })
                                </script>
                                    <script th:inline="javascript" >
                                    $("#idPedido" + [[${repo.idReplacementOrder}]]).click( function() {
                                        const swalWithBootstrapButtons = Swal.mixin({
                                            customClass: {
                                                confirmButton: "btn btn-success",
                                                cancelButton: "btn btn-danger"
                                            },
                                            buttonsStyling: false
                                        });
                                        swalWithBootstrapButtons.fire({
                                            title: "¿Estás seguro de cancelar este pedido de reposición #"+ [[${repo.idReplacementOrder}]] + " ?",
                                            text: "Esta acción es irreversible",
                                            icon: "warning",
                                            showCancelButton: true,
                                            confirmButtonText: "Sí, lo deseo eliminar",
                                            cancelButtonText: "Regresar",
                                            reverseButtons: true
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                window.location.href = '/cancelarPedidoReposicion?id='+ [[${repo.idReplacementOrder}]] ; // Aquí coloca la URL a la que quieres redirigir
                                            }
                                        });
                                    });
                                </script>

                                    <script th:inline="javascript" >
                                    $("#" + [[${repo.idReplacementOrder}]]).click( function(){
                                        data={
                                            idPedidoReposicion : [[${repo.idReplacementOrder}]]
                                        }
                                        console.log("Hola");
                                        $.ajax({
                                            url: "/verDetalleRepoMedicamentos",
                                            type: "POST",
                                            data: data,
                                            success: function(response) {
                                                console.log(response);
                                                var Header = "<table class=\"table\">\n                                                                  <thead>\n                                                                    <tr>\n                                                                      <th>#</th>\n                                                                      <th>Nombre</th>\n                                                                                                                                           <th>Precio</th>\n                                                                      <th>Categoría</th>\n                                                                      <th>Cantidad</th>\n                                                                    </tr>\n                                                                  </thead>\n                                                                  <tbody>";
                                                var rowx ;
                                                var count = 1;
                                                var rows ="";
                                                response.forEach(function(producto){
                                                    var aux = JSON.parse(producto)
                                                    rowx = '<tr> ' +
                                                        '<td>'+ count +'</td>'
                                                        +
                                                        '<td>'+ aux.name +'</td>'
                                                        +

                                                        '<td>'+ aux.price +'</td>'
                                                        +
                                                        '<td>'+ aux.category +'</td>'
                                                        +
                                                        '<td>'+ aux.initial +'</td>'
                                                        +
                                                        '</tr>';
                                                    rows =rows+rowx;
                                                    count++;
                                                })
                                                var final = "</tbody>\n                                                                </table>";

                                                Swal.fire({
                                                    title: 'Medicamentos de la orden de reposición',
                                                    html: Header+rows+final,
                                                    confirmButtonColor: "#dd986a"
                                                })
                                            },
                                        })
                                    })
                                </script>



                            </tr>
                            <!--
                            <!td>
                                <a class="me-3" href="editproduct.html">
                                    <img src="assets/img/icons/edit.svg" alt="img">
                                </a>
                            <!/td>
                            -->
                            </tbody>
                        </table>
                    </div>
                    <script>
                        function verDetalle(id){
                            $.ajax({
                                url: "/verDetalleRepoMedicamentos",
                                type: "POST",
                                data: id,
                                success: function(data) {
                                    Swal.fire({
                                        icon: "error",
                                        iconColor: "orange",
                                        title: "¡Correo o contraseña incorrectos!",
                                        confirmButtonColor: "#dd986a"
                                    })
                                },
                            })
                        }
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /Main Wrapper -->

<!-- jQuery -->
<script src="/assets_superAdmin/js/jquery-3.6.0.min.js"></script>

<!-- Feather Icon JS -->
<script src="/assets_superAdmin/js/feather.min.js"></script>

<!-- Slimscroll JS -->
<script src="/assets_superAdmin/js/jquery.slimscroll.min.js"></script>

<!-- Datatable JS -->
<script src="/assets_superAdmin/js/jquery.dataTables.min.js"></script>
<script src="/assets_superAdmin/js/dataTables.bootstrap4.min.js"></script>

<!-- Bootstrap Core JS -->
<script src="/assets_superAdmin/js/bootstrap.bundle.min.js"></script>

<!-- Chart JS -->
<script src="/assets_superAdmin/plugins/apexchart/apexcharts.min.js"></script>
<script src="/assets_superAdmin/plugins/apexchart/chart-data.js"></script>

<!-- Custom JS -->
<script src="/assets_superAdmin/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>